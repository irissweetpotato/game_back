<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>stats_games.com — Leaderboard</title>
  <link rel="stylesheet" href="./styles.css" />
</head>
<body>
  <header class="site-header">
    <a href="/" class="site-title-header">stats-games.com</a>
    <div class="header-actions">
      <button class="header-btn" type="button" data-open="privacyModal">Privacy Policy</button>
      <button class="header-btn" type="button" data-open="aboutModal">About Service</button>
    </div>
  </header>

  <main class="wrap">
    <section class="panel" aria-label="Leaderboard">
      <div class="panel-top">
        <div class="panel-left">
          <div class="panel-h">Leaderboard</div>
          <div class="panel-sub" id="metaLine">Loading…</div>
        </div>

        <div class="controls">
          <button class="btn" id="firstBtn" type="button">« First</button>
          <button class="btn" id="prevBtn" type="button">‹ Prev</button>
          <div class="page-indicator" id="pageInfo">Page 1 / 1</div>
          <button class="btn" id="nextBtn" type="button">Next ›</button>
          <button class="btn" id="lastBtn" type="button">Last »</button>
        </div>
      </div>

      <div class="table-wrap" role="region" aria-label="Leaderboard table" tabindex="0">
        <table>
          <thead>
            <tr>
              <th class="col-rank">Rank</th>
              <th class="col-user">Player</th>
              <th class="col-score">Score</th>
              <th class="col-date">Updated</th>
            </tr>
          </thead>
          <tbody id="tbody">
            <tr><td colspan="4" class="state-cell">Loading…</td></tr>
          </tbody>
        </table>
      </div>

      <div class="panel-bottom">
        <div class="hint">API: <span class="mono">/leaderboard?page=1&amp;limit=10</span></div>
        <div class="hint" id="errorLine" aria-live="polite"></div>
      </div>
    </section>
  </main>

  <div class="modal-overlay" id="privacyModal" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="privacyTitle">
      <button class="close-btn" type="button" data-close="privacyModal" aria-label="Close">&times;</button>
      <h2 id="privacyTitle">Privacy Policy</h2>
      <p>
        stats_games.com provides statistics storage solutions for game developers.
        We store only the data required to deliver leaderboard and analytics features.
      </p>
      <p>
        We do not sell, rent, or share your data with third parties.
        Data is processed exclusively to provide services to our clients.
      </p>
      <p>
        We apply reasonable technical and organizational measures to protect information
        from unauthorized access, alteration, or disclosure.
      </p>
      <div class="contact">
        For privacy inquiries, contact:
        <br><strong>contact@stats-games.com</strong>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="aboutModal" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="aboutTitle">
      <button class="close-btn" type="button" data-close="aboutModal" aria-label="Close">&times;</button>
      <h2 id="aboutTitle">About stats_games.com</h2>
      <p>
        stats_games.com is a platform offering developers a convenient, fast, and cost-effective
        way to store and manage player statistics.
      </p>
      <p>
        The service helps you implement leaderboards quickly, reduce infrastructure costs, and keep
        your data under your control. We do not transfer data to third parties.
      </p>
      <div class="contact">
        For business inquiries and integration requests:
        <br><strong>contact@stats-games.com</strong>
      </div>
    </div>
  </div>

  <script>
    // ===== Modals =====
    function openModal(id){
      const el = document.getElementById(id);
      if (!el) return;
      el.style.display = "flex";
      el.setAttribute("aria-hidden", "false");
    }
    function closeModal(id){
      const el = document.getElementById(id);
      if (!el) return;
      el.style.display = "none";
      el.setAttribute("aria-hidden", "true");
    }
    document.addEventListener("click", (e) => {
      const openId = e.target?.getAttribute?.("data-open");
      const closeId = e.target?.getAttribute?.("data-close");
      if (openId) openModal(openId);
      if (closeId) closeModal(closeId);
      if (e.target && e.target.classList && e.target.classList.contains("modal-overlay")) {
        e.target.style.display = "none";
        e.target.setAttribute("aria-hidden", "true");
      }
    });
    document.addEventListener("keydown", (e) => {
      if (e.key !== "Escape") return;
      document.querySelectorAll(".modal-overlay").forEach(m => {
        if (getComputedStyle(m).display !== "none") {
          m.style.display = "none";
          m.setAttribute("aria-hidden", "true");
        }
      });
    });

    // ===== Leaderboard (server-side pagination) =====
    const API_URL = "/leaderboard";
    const PAGE_SIZE = 10;

    const tbody = document.getElementById("tbody");
    const pageInfo = document.getElementById("pageInfo");
    const metaLine = document.getElementById("metaLine");
    const errorLine = document.getElementById("errorLine");

    const firstBtn = document.getElementById("firstBtn");
    const prevBtn  = document.getElementById("prevBtn");
    const nextBtn  = document.getElementById("nextBtn");
    const lastBtn  = document.getElementById("lastBtn");

    let rows = [];
    let page = 1;
    let totalPages = 1;
    let total = 0;

    function safeText(v){
      return String(v ?? "").replace(/[&<>"']/g, (c) => ({
        "&":"&amp;", "<":"&lt;", ">":"&gt;", '"':"&quot;", "'":"&#39;"
      }[c]));
    }
    function formatScore(n){
      const s = String(n ?? 0);
      return s.replace(/\B(?=(\d{3})+(?!\d))/g, " ");
    }
    function rankClass(rank){
      if (rank === 1) return "rank-1";
      if (rank === 2) return "rank-2";
      if (rank === 3) return "rank-3";
      return "";
    }
    function crownForRank(rank){
      return rank === 1 ? `<span class="crown" aria-hidden="true">👑</span>` : "";
    }

    function setButtons(){
      firstBtn.disabled = page <= 1;
      prevBtn.disabled  = page <= 1;
      nextBtn.disabled  = page >= totalPages;
      lastBtn.disabled  = page >= totalPages;
      pageInfo.textContent = `Page ${page} / ${totalPages}`;
    }

    function render(){
      metaLine.textContent = `Total: ${total} players • Showing ${PAGE_SIZE} per page`;
      errorLine.textContent = "";

      if (!rows.length){
        tbody.innerHTML = `<tr><td colspan="4" class="state-cell">No data.</td></tr>`;
        setButtons();
        return;
      }

      tbody.innerHTML = rows.map(u => `
        <tr>
          <td class="col-rank">
            <div class="rank ${rankClass(u.rank)}">
              <div class="rank-badge" title="Rank #${u.rank}">
                ${crownForRank(u.rank)}
                <span class="rank-num">${u.rank}</span>
              </div>
            </div>
          </td>

          <td class="col-user">
            <div class="user">
              <img class="avatar"
                   src="https://api.dicebear.com/7.x/bottts/svg?seed=${encodeURIComponent(u.guid)}"
                   alt="avatar" />
              <div>
                <div class="uname">
                  ${safeText(u.name)}
                  ${u.tag ? `<span class="utag">#${safeText(u.tag).replace(/^#/, "")}</span>` : ""}
                </div>
                <div class="uid mono">GUID: ${safeText(u.guid ?? "")}</div>
              </div>
            </div>
          </td>

          <td class="col-score">
            <span class="score mono">${formatScore(u.score)}</span>
          </td>

          <td class="col-date mono">${safeText(u.updatedAt)}</td>
        </tr>
      `).join("");

      setButtons();
    }

    async function loadLeaderboard(){
      try{
        tbody.innerHTML = `<tr><td colspan="4" class="state-cell">Loading…</td></tr>`;
        metaLine.textContent = "Loading…";
        errorLine.textContent = "";

        const res = await fetch(`${API_URL}?page=${page}&limit=${PAGE_SIZE}`, {
          method: "GET",
          headers: { "Accept": "application/json" },
          cache: "no-store"
        });

        if (!res.ok) throw new Error(`HTTP ${res.status}`);

        const json = await res.json();

        rows = Array.isArray(json.data) ? json.data : [];
        totalPages = Number(json.totalPages || 1) || 1;
        total = Number(json.total || 0) || 0;
        page = Number(json.page || page) || page;

        render();
      } catch (e){
        tbody.innerHTML = `<tr><td colspan="4" class="state-cell">Failed to load leaderboard.</td></tr>`;
        metaLine.textContent = "Leaderboard is unavailable.";
        errorLine.textContent = `Error: ${String(e?.message || e)}`;
        totalPages = 1;
        total = 0;
        setButtons();
      }
    }

    firstBtn.addEventListener("click", async () => { page = 1; await loadLeaderboard(); });
    prevBtn.addEventListener("click",  async () => { page = Math.max(1, page - 1); await loadLeaderboard(); });
    nextBtn.addEventListener("click",  async () => { page = Math.min(totalPages, page + 1); await loadLeaderboard(); });
    lastBtn.addEventListener("click",  async () => { page = totalPages; await loadLeaderboard(); });

    loadLeaderboard();
  </script>
</body>
</html>